{"id":378707,"avatar":"//lain.bgm.tv/pic/user/m/000/31/77/317704.jpg","floor":"#1","group":"～技术宅真可怕～","groupHref":"/group/a","groupThumb":"//lain.bgm.tv/pic/icon/m/000/00/00/11.jpg","message":"有个项目的后端用的是 Node.js + TypeScript，因为有类型系统所以写起来还是比原生 JS 舒服很多，然而日志系统让我很不爽：大部分日志框架默认配置都不会输出日志所在行信息（包括但不限于文件名、函数名、行号），偶尔需要排查的时候需要花挺长时间才能捋清楚（尤其如果日志到达日志系统的顺序和实际输出的顺序不一致的时候）。总之在某天又盯着日志看了 30 分钟之后，我认为这不是个办法，决定自己动手看看有没有办法。<br><br>翻了一圈，大概有两种实现思路：<br>1. 运行时获取：如 <a href=\"https://log4js-node.github.io/log4js-node/layouts.html#:~:text=%25l-,line%20number,-(requires%20enableCallStack%3A%20true\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">log4js</a>，但需要开启 enableCallStack 选项。原理大概是每次打日志的时候都 new Error (!) 来获取调用栈信息，然后通过解析调用栈信息获取行号 (<a href=\"https://github.com/log4js-node/log4js-node/blob/66337c177f756f4228ac9b16e1868ebf54029abd/lib/logger.js#L180\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">相关代码</a>)。这样的确不是不行，但是会有两个小问题：<br>a. 每次打日志都 new Error，似乎会有比较大的性能开销<br>b. 因为 TypeScript 有编译过程，实际上打出来的日志会是编译后的行号，而非编译前源文件的行号<br><br>2. 编译时修改：类似 <a href=\"https://github.com/furstenheim/gulp-log-line\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">gulp-log-line</a>，基本原理就是在编译前把源文件中所有打日志的行都找出来，然后在参数列表最前端插入一个包含文件名和行号的字符串。这样既大大减小了运行时开销，也保证了日志行号和源文件对应。唯一的问题是似乎没有太多人采取这个思路 (<span class=\"text_mask\" style=\"background-color:#555;color:#555;border:1px solid #555;\">更大的可能是我的搜索不够充分</span>)，翻了翻 npm 也没有现成支持 TypeScript 的采用了这一思路的包。<br><br>再经过一轮搜索之后，我找到了 TypeScript 中一个叫做 Transform 的特性（不是深度学习的那个），可以在编译前对代码 AST 进行修改。一轮 hack 之后，暂且是弄出了一个初步能用的原型：遍历 AST，找到 console.log 的方法调用，然后插入字符串参数。相比于直接在源文件上修改，通过 AST 改可能会能避免一些正则（或是其他匹配方式）预期之外的异常修改。可以看这个 Gist：<a href=\"https://gist.github.com/jerrylususu/af4ed41302123292983f9b4fd81909ef\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://gist.github.com/jerrylus ... 292983f9b4fd81909ef</a> 。当然，如果有其他更好的方式，也欢迎回复！（毕竟大概总比自己瞎搞强）<br><br>最后吐个槽：TypeScript 官方似乎是不打算支持 tsc （TypeScript 编译器）通过参数/配置文件方式直接使用 Transfromer 了 (<a href=\"https://github.com/Microsoft/TypeScript/issues/14419\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">issue</a>)，如果要用的话还得上一个社区魔改过的 ttypescript，何苦呢... <img src=\"/img/smiles/tv/15.gif\" smileid=\"54\" alt=\"(bgm38)\"> ","time":"2023-3-1 23:27","title":"碎碎念：Node.js 日志附带文件名和行号","userId":"317704","userName":"NekoNull","userSign":""}