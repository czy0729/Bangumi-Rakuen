{"id":381477,"avatar":"//lain.bgm.tv/pic/user/m/000/31/77/317704.jpg","floor":"#1","group":"～技术宅真可怕～","groupHref":"/group/a","groupThumb":"//lain.bgm.tv/pic/icon/m/000/00/00/11.jpg","message":"背景：在写一个玩具项目，其中某个接口接受一个用户提供的 JSON。需要解析这个 JSON 为对象并且使用里面的值，但用户提供的 JSON 可能和预期的 schema 不一致，导致使用的时候出现问题。<br><br>问题：如何安全的将一个 JSON 字符串转化成一个特定类型的对象（例如某个 interface）？<br><br>据我了解有以下几种方式，但是感觉都不太舒服...<br>1. JSON.parse 之后直接 as 强转：虽然有自动补全了，不过运行时就得看运气了，就算给了异常的 JSON 就会炸<br>2. 强转之后手动校验：字段数量少的可能还可以作为 workaround，字段数量多or有嵌套的时候就难受了<br>3. 编译时生成校验函数：<span style=\"text-decoration: line-through;\">需要把生成的校验函数提交到源代码里，造成代码库膨胀</span> （之前误解了，ajv 等工具是支持运行时校验的，代码生成是可选项）<br>- 3a. 基于 JSON 结构（<a href=\"https://app.quicktype.io/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">quicktype</a>）<br>- 3b. 基于另外指定的 schema（ajv / validate.js / <a href=\"https://github.com/Q42/openapi-typescript-validator\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">openapi-typescript-validator</a>）<br>- 3c. 基于已定义的 interface（<a href=\"https://github.com/ForbesLindesay/typescript-json-validator\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">typescript-json-validator</a>）<br>4. 运行时校验（<a href=\"https://github.com/typestack/class-transformer\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">class-transformer</a>）：最直观，不用生成代码，但目前用法得加不少 annotation（例如 interface 内嵌套的 array）<br><br><br>最理想的是在4基础上做改进，消除使用 annotation 的需要，但目前看来不太可能。这里的核心问题是 TypeScript 在编译时类型擦除了，导致运行时没有足够的类型信息来做检查。目前看来最优解可能是先定义 schema，然后同时生成 interface + 校验函数？所以各位有什么好的库推荐吗？或是实践中其他项目是如何解决这类问题的？真心求教。<img src=\"/img/smiles/tv/15.gif\" smileid=\"54\" alt=\"(bgm38)\"><br><br>23/5/8：感谢各位的回复！目前是在 <a href=\"https://github.com/colinhacks/zod\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">zod</a> 和 <a href=\"https://github.com/sinclairzx81/typebox\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">typebox</a> 中纠结，两者看起来都很棒，估计要稍微多写一些感受下了。不过无论如何这也比 as 硬转或是代码生成强太多了。 ","time":"2023-5-7 22:18","title":"(已解决) TypeScript 中解析 JSON 到特定类型的对象？","userId":"317704","userName":"NekoNull","userSign":""}