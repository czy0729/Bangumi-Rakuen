{"id":375970,"avatar":"//lain.bgm.tv/pic/user/m/000/31/77/317704.jpg","floor":"#1","group":"～技术宅真可怕～","groupHref":"/group/a","groupThumb":"//lain.bgm.tv/pic/icon/m/000/00/00/11.jpg","message":"坐地铁上班时总有一段路程没有信号。在无聊地盯着地铁图看的时候，突然一个想法闯入脑中：如何在地铁图上找到最长的环形路线？作为一个半吊子的铁道/交通爱好者和全职的程序员，这个问题似乎我早就应该开始思考了。<br><br>显然可以把这个问题进一步抽象，即在无向图中寻找最长环。这里的环在定义上同时符合图论定义（一条只有第一个和最后一个顶点重复的非空路径）和直觉定义（每个车站只经过一次，首尾车站除外）。许久未用的算法知识已经生锈，只好 Google 一下，然而发现这个问题并没有想象中这么简单。<br><br>无向图可以计算 cycle base （环基？），每个 cycle base 包含一组边，这组边共同组成了一个环。用这些 cycle base 进行组合（XOR）可以得到无向图中的所有可能环。[1] 简单的说。如果两个 cycle bases 有共享的边（AND 结果不为 0），那么会得到一个新的环，可以想象成把两个环融合在了一起，共享的边自动消去；如果没有共享的边，XOR 组合后的结果是两个独立的环。<br>（注：另一个与此相关的是汉密尔顿环（哈密顿环）问题，即在无向图上寻找一个能经过所有顶点的环。这是个已知的 NP Hard 问题，目前没有特别有效的算法。）<br><br>由此可以得到一个比较直接的思路：计算地铁图中的所有 cycle base -> 计算这些 cycle base 的所有可能组合(???) -> 找到所有环中最大的 -> 完成（Profit!），但实际操作起来就会发现似乎有点问题。<br><br>我当前所在的城市是深圳，目前现网总计 281 个车站/顶点，327 个区间/边。把数据从地铁官网[2]扒下来很简单，计算 cycle base 也有现成的包可以做[3]。一番操作下来，我得到了 48 个 cycle bases。剩下来的问题就是计算所有可能的环并找出其中的最大环了，但是有两个问题。其一是计算量太大，cycle bases 之间的组合实际上是 2^n 的，每次组合时可以选择每个 cycle base 是否参加。其二是结果有效性，正如之前讨论的，如果组合的时候没有共享的边，最后组合完成可能得到多个独立的环，而不是一个连续的大环，前者并不是我想要的。不过这些问题也不是不能解决：计算量上，既然组合空间太大，可以用遗传算法之类的探索-利用框架来减少搜寻的数量；有效性上，可以多写几个辅助的检查函数，如果组合后环不连续，尝试丢弃一个或多个 cycle bases 再试。（实际跑的时候似乎还有些诡异的问题，例如结果中有的环似乎会对一个车站重复进入多次，导致结果不合法，这里最后也是补了检查函数计算每个站点的出现次数解决的。）<br><br>让遗传算法跑了 500 个种子之后，目前我的算法能找出一条长度 135 的路径，看起来似乎不错，至少包含了地铁图上 48% 的车站。如果站均用时一分半，已经足够让我超出最长地铁乘坐时限了。但当我把这条路径在地铁图上描出之后（黑色实线，从右下老街站开始），却发现我可以直接改进这个路径（左侧棕色虚线）让它更长，所以这显然不是一个最优解。<br><br>于是我写了这个帖子，来求助万能的班友，希望能：<br>1. 找到地铁图上的最长环（无论是人肉还是代码）<br>2. 用代码找到地铁图上的最长环（改进我的思路，或者提出其他思路）<br><br>万分感激！<br><br>如果你对这个想法感兴趣，也欢迎在自己所在城市的地铁图上试试（如果所在城市有的话）。<br><br>我的代码和结果：<br><a href=\"https://gist.github.com/jerrylususu/d95e4999d68c9657f4f803ff7edcfcc3\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://gist.github.com/jerrylus ... 657f4f803ff7edcfcc3</a><br><img src=\"https://p.sda1.dev/9/188c0a56cdf0c007bea617035f4e79c2/map.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br>参考：<br>[1] <a href=\"https://stackoverflow.com/questions/12367801/finding-all-cycles-in-undirected-graphs\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://stackoverflow.com/questi ... n-undirected-graphs</a><br>[2] <a href=\"https://www.szmc.net/styles/index/js/metroStationsList.js\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://www.szmc.net/styles/index/js/metroStationsList.js</a><br>[3] <a href=\"https://networkx.org/documentation/stable/reference/algorithms/generated/networkx.algorithms.cycles.cycle_basis.html#networkx.algorithms.cycles.cycle_basis\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://networkx.org/documentati ... .cycles.cycle_basis</a><br><br>---<br><span style=\"font-weight:bold;\">更新</span>（2022/12/15 15:16）：感谢 @Komeiji⚓ 的回复！试了一下 graphillion 库，支持直接计算长度大于 n 的环的数量（不确定用了什么黑科技）。随手 range(150,170) 一下后，很快找到了几组长度为 164 的解（区间比较小懒得二分了），而且计算时间也大大缩短（大概只要 5 分钟）。相关代码已经更新回 gist。目测了一下新路径，应该是最优了，至少我盯着图看了几分钟没看到可以优化的地方）<br><br>新路径如下图所示：（右下角 老街站 出发。其中 少年宫->岗厦 区间有 3 条子路径可选）<br><br><img src=\"https://p.sda1.dev/9/c91f9d9604aec5146ba5b6398c208b3a/Screenshot 2022-12-25 14.54.56.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br>具体路径：['老街', '晒布', '翠竹', '田贝', '洪湖', '笋岗', '红岭北', '泥岗', '银湖', '八卦岭', '黄木岗', '华新', '莲花村', '冬瓜岭', '孖岭', '雅宝', '南坑', '光雅园', '五和', '坂田', '杨美', '上水径', '下水径', '长龙', '布吉', '百鸽笼', '布心', '太安', '怡景', '黄贝岭', '湖贝', '大剧院', '燕南', '华强北', '华强南', '赤尾', '皇岗口岸', '福民', '皇岗村', '石厦', '沙尾', '上沙', '车公庙', '下沙', '深圳湾公园', '深湾', '红树湾南', '高新南', '粤海门', '深大南', '南山书城', '南油', '南油西', '荔林', '怡海', '梦海', '前湾', '前湾公园', '妈湾', '铁路公园', '荔湾', '赤湾', '蛇口港', '海上世界', '水湾', '东角头', '湾厦', '海月', '登良', '后海', '科苑', '红树湾', '世界之窗', '白石洲', '高新园', '深大', '桃园', '南头古城', '中山公园', '同乐南', '新安公园', '灵芝', '上川', '流塘', '宝安客运站', '宝田一路', '平峦山', '西乡桃源', '钟屋南', '黄田', '兴围', '机场东', '后瑞', '固戍', '西乡', '坪洲', '宝体', '宝安中心', '宝华', '临海', '前海湾', '宝安', '碧海湾', '机场', '机场北', '国展南', '国展', '福海西', '桥头西', '福永', '桥头', '塘尾', '马安山', '沙井', '后亭', '松岗', '溪头', '松岗公园', '薯田埔', '合水口', '公明广场', '红花山', '楼村', '科学公园', '光明', '光明大街', '凤凰城', '长圳', '上屋', '官田', '阳台山东', '元芬', '上芬', '红山', '深圳北站', '长岭陂', '塘朗', '大学城', '西丽', '茶光', '珠光', '龙井', '桃源村', '深云', '安托山', '侨香', '香蜜', '香梅北', '景田', '梅景', '下梅林', '梅村', '上梅林', '莲花北', '少年宫', '福田', '购物公园', '会展中心', '市民中心', '岗厦北', '岗厦', '华强路', '科学馆', '通新岭', '红岭']<br><br>可选子路径（少年宫->岗厦 区间）<br>- 少年宫 -> 福田 -> 购物公园 -> 会展中心 -> 市民中心 -> 岗厦北 -> 岗厦<br>- 少年宫 -> 市民中心 -> 会展中心 -> 购物公园 -> 福田 -> 岗厦北 -> 岗厦<br>- 少年宫 -> 市民中心 -> 岗厦北 -> 福田 -> 购物公园 -> 会展中心 -> 岗厦 ","time":"2022-12-24 23:35","title":"地铁图上的最长环","userId":"317704","userName":"NekoNull","userSign":""}