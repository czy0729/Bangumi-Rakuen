{"id":413138,"avatar":"//lain.bgm.tv/pic/user/m/000/37/04/370405.jpg","floor":"#1","group":"用户脚本 · 样式 · 插件","groupHref":"/group/u_devs","groupThumb":"//lain.bgm.tv/pic/icon/m/000/00/41/4116.jpg?r=1478867893","message":"<span style=\"font-weight:bold;\">标题无关但重要：如果你从菜鸟教程之类的地方学完了 JavaScript 基础，知道如何操作页面上的元素，想做组件但无从下手，主要需要学习的 JavaScript</span><br>- fetch：使用 API 或获取其他网络资源<br>- Mutation Observer：检查其他组件对页面的修改/bangumi对页面的动态修改<br>- localStorage，sessionStorage，IndexedDB：存储组件的设置和缓存等<br>推荐：<a href=\"https://zh.javascript.info/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">现代 JavaScript 教程</a><br>- jQuery：简化 DOM 操作和请求<br>另外不要忘记善用AI！<br><br><span style=\"font-weight:bold;\">API</span><br><br>1. 公开API：<a href=\"https://bangumi.github.io/api/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://bangumi.github.io/api/</a>（<a href=\"https://bgm.tv/group/topic/350650\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">班友总结的使用建议</a>）<br>使用 access token 进行用户认证，GET 请求支持跨域。<br>获取 access token 的方法：<br>  - 法一：引导用户到<a href=\"https://next.bgm.tv/demo/access-token/create\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">此处</a>创建，粘贴存储到组件里。最好不要用 localStorage 等存储到浏览器中，以免暴露 access token。<br>  - 法二：<a href=\"https://bgm.tv/dev/app/create\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">创建“应用”</a>，使用获得的 App ID 和 App Secret 进行 OAuth 授权。因为需要后端存储 App Secret，组件难以使用此方法，也可以使用 Pipedream 等 serverless 平台。（参考：<a href=\"https://github.com/bangumi/api/blob/master/docs-raw/How-to-Auth.md\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">用户授权机制</a>）<br>注意很多 API 不需要 access token。<br>除了上方链接中的建议：<br>- /v0/search 系列API搜索结果不如旧API /search（<a href=\"https://github.com/bangumi/server/issues/229\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://github.com/bangumi/server/issues/229</a>）<br><br>2. 私有API：<a href=\"https://bangumi.github.io/dev-docs/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://bangumi.github.io/dev-docs/</a><br>使用（新站的） cookies session 进行用户认证，目前仍处于开发阶段，无兼容性保证，不支持跨域。如果新站上线后仍有组件功能，可以在新站使用。<br><br>3. 旧公开 API 等：<a href=\"https://github.com/jabbany/dhufufu/tree/master/bangumi\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://github.com/jabbany/dhufufu/tree/master/bangumi</a> / <a href=\"https://bgm.tv/group/topic/344553\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">站内查询入口/用户相关</a>（班友整理）<br>出于兼容考虑旧 API 依旧能访问但已不推荐使用，相关 API 文档已隐藏。<br><br>参考：<a href=\"https://github.com/bangumi/dev-docs\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://github.com/bangumi/dev-docs</a><br><br>4. 班友制作的第三方API<br>4.1 <a href=\"https://bgm.tv/group/topic/386829\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">VIB数据API</a><br><div class=\"codeHighlight\"><pre>GET https://api.jirehlov.com/vib/{id}</pre></div>4.2 <a href=\"https://bgm.tv/group/topic/382270\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">发帖/回帖/贴贴 统计API</a><br><div class=\"codeHighlight\"><pre>POST https://bgm.nyamori.moe/forum-enhance/query<br>格式: {\"users\":[\"304116\",\"trim21\",\"sai\"],\"type\":\"group\"}<br>- type可以是group, subject, blog。</pre></div>4.3 <a href=\"https://bgm.tv/group/topic/374807\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">讨论贴历史记录API</a>（https://bgm.nyamori.moe）<br><div class=\"codeHighlight\"><pre>GET /history/(subject|group)/:topicId/link<br>GET /history/(subject|group)/:topicId/latest: 会自动302跳到最新的json<br>GET /history/(subject|group)/:topicId/:millisecondTimestamp/html: 会显示原始爬下来的html<br>GET /history/(subject|group)/:topicId/latest/html: 会显示最新爬到的html<br>GET /history/(subject|group)/:topicId<br>GET /history/(subject|group)/:topicId/:millisecondTimestamp</pre></div>4.4 <a href=\"https://bgm.tv/group/topic/382290\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">查看被删回复API</a><br><div class=\"codeHighlight\"><pre>GET https://bgm.nyamori.moe/forum-enhance/deleted_post/:type/:topicId/:postId<br>type可以是group, subject , blog。返回的是被删前最后更新的内容的html纯文本。<br>如果未收录会返回404。</pre></div><br><br>5. 没有官方 API/不想使用 access token 时：<br>  - 直接获取页面，解析HTML<br>  - 检查页面 form 标签的 action 属性值（此时 POST 请求需要设为 URLSearchParams）<br>  - 使用 控制台 - Network/网络 检查是否抓得到<br><br><span style=\"font-weight:bold;\">全局变量</span><br><br>0. 可用 jQuery<br>1. 在组件中使用全局变量的方法：window.变量<br>  - 若在油猴脚本中，需要在开头加上：<br><div class=\"codeHighlight\"><pre>// @grant unsafeWindow</pre></div>  并使用 unsafeWindow.变量<br>  - 除了调用，也可以直接覆盖，改变所有使用相关变量的原网站操作<br>2. 全部全局变量（获得方法：在未开启任何组件的 bangumi 获得的 window 的属性与在空白页获得的 window 的属性不相交的部分，存在不准确）<br><div class=\"codeHighlight\"><pre>SHOW_ROBOT<br>CHOBITS_UID<br>SITE_URL<br>CHOBITS_VER<br>submitPost<br>submitTip<br>subReplycancel<br>eraseSubjectTopic<br>PostTo<br>SetTips<br>eraseSubjectCollect<br>subReply<br>chiiLib<br>getObj<br>designDefault<br>fetchInPageSubjectID<br>eraseClubTopic<br>erasePM<br>checkall<br>MoreElement<br>switchDisplay<br>infoboxid<br>disconnectFriend<br>eraseEntry<br>tb_pathToImage<br>eraseGrpTopic<br>nowmode<br>regSetNickName<br>seditor_ctlent<br>removeListItem<br>AJAXtip<br>infoboxVal<br>submitError<br>ignoreUser<br>checkTsukkomiInput<br>tb_init<br>tb_show<br>tb_showIframe<br>tb_remove<br>tb_position<br>tb_parseQuery<br>tb_getPageSize<br>tb_detectMacXFF<br>sizeContent<br>AddMSGreceiver<br>GenInterestBox<br>switchRobotSpeech<br>WikiTpl<br>WCODEParse<br>WCODEDump<br>WCODEtoNormal<br>NormaltoWCODE<br>addSubProp<br>stopEnterSubmit<br>multiKeyRegDel<br>addoneprop<br>log<br>dataLayer<br>imgLoader<br>OML2D<br>Live2DCubismCore<br></pre></div><br>3. 部分可能有用的全局变量<br>  - CHOBITS_UID：当前登录用户的数字UID<br>  - SITE_URL：当前域名<br>  - chiiLib<br>    - ukagaka<br>      - toggleDisplay()：切换春菜显示<br>      - presentSpeech(html, auto_dismiss = false, slide_down = true)：春菜说话<br>若无法找到如何使用全局变量中的函数，可尝试查看压缩后的代码：<a href=\"https://bgm.tv/min/g=js\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">主要内容</a>、<a href=\"https://bgm.tv/min/g=editor\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">文本编辑相关</a>（<a href=\"https://www.unminify2.com/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">还原工具推荐</a>）<br><br><span style=\"font-weight:bold;\">其他</span><br>- 在 console 中输入以下命令可查看组件 log（参考：<a href=\"https://chii.in/group/topic/345162\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[Changelog] 组件功能更新记录</a>）：<br><div class=\"codeHighlight\"><pre>log.setLevel('debug'); </pre></div>使用下方命令取消：<br><div class=\"codeHighlight\"><pre>log.disableAll();</pre></div><br>- 疑似因为过时的 polyfill，bangumi 的 Promise 不支持 Promise.allSettled、Promise.any 等 2020 后的 Promise 方法<br><br>过去相关整理：<a href=\"https://bgm.tv/group/topic/344553\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">一些基础的开发参考资料</a>","time":"2024-12-30 15:51","title":"开发组件相关的 bangumi 资源","userId":"inchei","userName":"茵陳","userSign":"(Hello darkness my old friend)"}