{"id":392122,"avatar":"//lain.bgm.tv/pic/user/m/000/83/73/837364.jpg","floor":"#1","group":"～技术宅真可怕～","groupHref":"/group/a","groupThumb":"//lain.bgm.tv/pic/icon/m/000/00/00/11.jpg","message":"Hello，大家晚上好呀！<br><br>我是<span style=\"color: #c14700;\"><span style=\"font-weight:bold;\">小玉</span></span>（Bangumi for Android 原生安卓客户端的开发者，具体了解戳这里 <a href=\"https://bgm.tv/group/topic/391651\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://bgm.tv/group/topic/391651</a>）<br><br>今天我来为大家揭秘为什么你的浏览器老是掉登录状态，以及<span style=\"color: #ff5f54;\">罪魁祸首的真正的原因</span> 和修复超合金插件。<br><br>在此之前，想必在看的各位 Bgmer 也遇到过或经常遇到每天都打开浏览器，激动的打开 bgm 看看哪些剧集更新了，结果页面一点开两个冰冷的的登录框框显示在那，每次都<span style=\"color: #ff4136;\">没勾选</span><span style=\"color: #e82a1f;\"><span style=\"font-weight:bold;\">不保存我的登录信息</span></span>，结果每次打开浏览器，登录状态都没了，是不是很生气&#x1F620;。<br><br><span style=\"font-weight:bold;\">首先咱来分析分析，我的登录状态为什么会丢失？</span><br>想必大家之前也浏览过许多 Bgmer 写过关于登录状态丢失的帖子，有认为是 <span style=\"color: #e82a1f;\">IP 地址</span> 变了导致的登录失效，有认为是<span style=\"color: #e82a1f;\"> 浏览器 UA </span>变了导致的登录失效，还有些其它的分析。结果后来测试发现，其实这些都<span style=\"font-weight:bold;\"><span style=\"color: #e82a1f;\">是影响登录状态失效的原因</span></span>，但还有一个额外的方法可以在这些信息变化后保持登录状态，即有重新刷新当前环境的方法。<br><br>先给小白科普一下什么是Cookie，以及浏览器如何识别是我在浏览，而不是隔壁老王。<br><br><span style=\"font-weight:bold;\">Cookie 是什么？</span><br>Cookie就像一张小纸条，是网站给你电脑上放的一点信息。这个信息可以告诉网站一些关于你的事情，比如你上次访问的时间、你喜欢的颜色等。<br><br><span style=\"font-weight:bold;\">浏览器怎么识别用户身份的？</span><br>当你第一次访问一个网站时，它会给你电脑上放一个小纸条，上面有一个特殊的标记，就像是一个身份证号码。以后你再访问这个网站时，浏览器会把这个小纸条带上，告诉网站“嘿，我是之前那个人”，这样网站就知道你是谁了。<br><br><span style=\"font-weight:bold;\">Cookie 有效期是什么意思？</span><br>小纸条上有一个日期写着，就像食品上的保质期一样。如果过了这个日期，浏览器就不再带着这个小纸条去访问网站。这时候，网站可能会要求你重新登录，就好像你需要重新出示身份证一样。这个有效期有时很短，有时很长，取决于网站的设置。<br><br>明白了 Cookie 这个东东后，废话不多说，接下来作为一位技术人员为大家分析，接下来直接上干货！<br><br>1、首先清理浏览器数据，打开 BGM 登录页面 <a href=\"https://bgm.tv/login\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://bgm.tv/login</a>，此时 Cookie 如下：<br><br><img src=\"https://lain.bgm.tv/pic/photo/l/38/0f/841153_7u93y.jpg\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br>2、然后登录，登录成功后，再查看 Cookie 如下：<br><br><img src=\"https://lain.bgm.tv/pic/photo/l/38/0f/841153_D1Fkh.jpg\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>此时睿智的你发了问题所在了吗？是的没错，就是这个名为 chii_auth 的 Cookie 有猫腻，它的有效期仅在会话期间！这里给不懂得小伙伴科普下，有效为会话的 Cookie 会在浏览器关闭后自动清理掉。<br>正常情况这个 Cookie 有效期应该和其它的 Cookie 一致，大约为一年左右，由于这里有效期仅在会话期间，所有每当你的浏览器进程关闭时，这个 Cookie 就被清理了，下次打开浏览器，没有这个名为 <span style=\"color: #e82a1f;\">chii_auth</span> 的 Cookie，服务端只能验证 <span style=\"color: #e82a1f;\">chii_sid</span> 这个 Cookie，但是这个 Cookie 的有效期只有 7 天（实际上服务端校验后比这个更短），就会导致无法刷新验证，而且这个会根据你的IP地址或浏览器环境变化等立即失效。<br><br>经过多次实验，这个名为 <span style=\"color: #e82a1f;\">chii_auth</span> 的 Cookie实际上是刷新身份有效期的关键，即使没有这个 <span style=\"color: #e82a1f;\">chii_sid</span> Cookie，也会重新生成。<br><br><span style=\"font-weight:bold;\">经过上面的分析，至此浏览器间隔性登录失效的原因找到了</span>，可能是因为网络环境变化，且你的浏览器本地 Cookie 管理内没有有效的 chii_auth。<br><br>接下来咱分析分析为什么这个名为 chii_auth 的 Cookie 有效期被设置为了仅会话期间，<br>咱仔细看下这个名为 chii_auth 的 Cookie 在哪个请求后返回的，在登录流程的 FollowTheRabbit 这个请求响应体内，发现了该 Cookie。<br><br><img src=\"https://lain.bgm.tv/pic/photo/l/38/0f/841153_Mmh3y.jpg\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br>(ÒωÓױ)！熟悉技术的小伙伴应该早早知道了原因，就是因为这个 chii_auth Cookie，在这个登录请求返回后，没有设置有效期，浏览器会将此类 Cookie 的有效期默认设置为仅会话期间，所以就出现了前面讲的困扰大家许久的问题（当然网站可能就是这样设计的，并且网络或浏览器环境变化需要重新登录），但是由于用户携带的笔记本等网络环境可能经常变化，所以会老掉登录状态。<br><br><span style=\"font-weight:bold;\">解决方案（超大声！）</span><br><br>今天我为大家带来了一款超合金插件【<span style=\"color: #ff0000;\"><a href=\"https://bgm.tv/dev/app/2883\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\"><span style=\"font-weight:bold;\">登录持久化插件</span></a></span>】【<span style=\"color: #e82a1f;\">审核中，有点慢</span>】，动动小手指，轻轻松松解决困扰了你许久的问题，快来试试叭！<br>其原理就是给 chii_auth 手动设置一个过期时间，让其在浏览器进程结束时不清理掉，后续即使网络环境变化了，chii_auth 存在也可以保持登录状态。<br><br><span style=\"color: #e82a1f;\">来不及等待审核的小伙伴可以自己复制代码创建一个插件。</span><br><span style=\"color: #e82a1f;\">脚本开源地址: <a href=\"https://github.com/bangumi/scripts/tree/master/xiaoyvyv\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">传送门</a></span><br><br>使用教程：<br>1、在超合金组件内成功启用该组件；<br>2、然后退出登录（对的，就是退出登录），重新打开登录页面并登录；<br>3、重新登录成功后，在隐私设置页面 <a href=\"https://bgm.tv/settings/privacy\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://bgm.tv/settings/privacy</a> 勾选持久化并保存，到此即可完成登录信息持久化。<br><br>是不是很简单，快来试试吧！<br>注意：每次重新登录后，都需要进入隐私设置页面，重新选择持久化并保存（不管默认是否选中的持久化）。<br><br>题外话：我还开发了一款全功能的 Bangumi for Anddroid 原生安卓客户端，超超超流畅，完全开源欢迎大家 Star 和使用。<br><br>帖子传送门：<a href=\"https://bgm.tv/group/topic/391651\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://bgm.tv/group/topic/391651</a><br>开源地址：<a href=\"https://github.com/xiaoyvyv/Bangumi-for-Android\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://github.com/xiaoyvyv/Bangumi-for-Android</a>","time":"2024-1-5 19:50","title":"【超合金组件】登录持久化修复插件，以及简述一下登录状态丢失的真正的原因以及插件修复原理","userId":"xiaoyvyv","userName":"小玉","userSign":""}