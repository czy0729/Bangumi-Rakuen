{"id":400354,"avatar":"//lain.bgm.tv/pic/user/m/000/13/14/131492.jpg","floor":"#1","group":"SelfHost _自建NAS与媒体库","groupHref":"/group/nas","groupThumb":"","message":"Loki的安装方式：<a href=\"https://grafana.com/docs/loki/latest/setup/install/local/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://grafana.com/docs/loki/latest/setup/install/local/</a><br>我这里采用本地安装了，应为win上docker是跑在hyperv里，性能不是很强而且磁盘占用也大。<br>首先按照教程下载好二进制和配置文件<br><a href=\"https://github.com/grafana/loki/releases/download/v2.9.8/loki-windows-amd64.exe.zip\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://github.com/grafana/loki/ ... ndows-amd64.exe.zip</a><br><a href=\"https://github.com/grafana/loki/releases/download/v2.9.8/promtail-windows-amd64.exe.zip\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://github.com/grafana/loki/ ... ndows-amd64.exe.zip</a><br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-221205.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>按照教程启动试试<br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-205102.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>直接报错，查了下不应该用main分支的简单配置，换成我下载的版本分支对应的简单配置：<br><a href=\"https://github.com/grafana/loki/blob/v2.9.8/cmd/loki/loki-local-config.yaml\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://github.com/grafana/loki/ ... i-local-config.yaml</a><br><br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-205102.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>可以启动了：<br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-205710.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>接下来在grafana的数据源里添加一下Loki，默认配置文件用的就是3100端口，配置其实什么都不用改<br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-205826.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-210053.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br>之后配置一下Promtail采集NAS上服务打印的日志文本，这里因为我使用winsw封装服务，日志都统一打印在了~/Desktop/logs文件夹<br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-221953.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>启动一下promtail试试<br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-222115.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>开始收集日志了<br><br>这里有一个问题，因为我的日志比较大，需要loki解除下限制才能推送过去<br>网上随手复制的配置<br><div class=\"codeHighlight\"><pre><br>limits_config:<br>  retention_period: 72h<br>  enforce_metric_name: false<br>  reject_old_samples: true<br>  reject_old_samples_max_age: 168h<br>  max_cache_freshness_per_query: 10m<br>  split_queries_by_interval: 15m<br>  # for big logs tune<br>  per_stream_rate_limit: 512M<br>  per_stream_rate_limit_burst: 1024M<br>  cardinality_limit: 200000<br>  ingestion_burst_size_mb: 1000<br>  ingestion_rate_mb: 10000<br>  max_entries_limit_per_query: 1000000<br>  max_label_value_length: 20480<br>  max_label_name_length: 10240<br>  max_label_names_per_series: 300<br></pre></div><br><br>之后在Grafana里就可以搜索日志了<br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-231007.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><img src=\"https://azusebox.moe/wp-content/uploads/2024/06/screenshot-20240618-231001.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br>不过label比较少，不太好区分，可以利用promtail的正则relabel重新从文件名里提取标签<br>我配置了提取不过没有生效，时间太晚，就下次再排查吧<br><div class=\"codeHighlight\"><pre><br>scrape_configs:<br>- job_name: system<br>  static_configs:<br>  - targets:<br>      - localhost<br>    labels:<br>      job: varlogs<br>      __path__: \"C:/Users/azuse/Desktop/logs/*.log\"<br>      stream: stdout<br>  relabel_configs:<br>  - source_labels: <br>    - filename<br>    regex: (.*?)_(.*?)\\.(.*?)\\.log<br>    target_label: 'service'<br>    replacement: '$1'<br></pre></div>","time":"2024-6-18 23:16","title":"Loki采集NAS日志并用Grafana查看","userId":"misakaxindex","userName":"東瀬まつり🦋❄️🐻💎🐺🍎🐠","userSign":"([s]安静点格子[/s] ☄️⚓ ☁️⭐️)"}