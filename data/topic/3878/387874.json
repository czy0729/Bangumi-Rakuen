{"id":387874,"avatar":"//lain.bgm.tv/pic/user/m/000/34/82/348269.jpg","floor":"#1","group":"～技术宅真可怕～","groupHref":"/group/a","groupThumb":"//lain.bgm.tv/pic/icon/m/000/00/00/11.jpg","message":"前情提要: <br>如何评价诈骗网站<br><a href=\"https://bgm.tv/group/topic/387819\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://bgm.tv/group/topic/387819</a><br><br>其中一个可能的泄露访问域名的途径是TLS握手时的明文SNI扩展字段 (Server Name Indication), 另一个是DNS(域名解析)。对于DNS, 已有DNS over HTTPS / DNS over TLS等方案以规避明文传输的问题。<br><br><img src=\"https://p.sda1.dev/13/b68df34c92dc7a9fa38cf76e2b56cd24/ws_sni_bgm.tv.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br><br>对于明文SNI, TLS加密SNI(Encrypted SNI)草案于2018年起草(<a href=\"https://blog.cloudflare.com/encrypted-sni/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[1]</a>), 又经过数年迭代(<a href=\"https://blog.cloudflare.com/encrypted-client-hello/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[2]</a>, <a href=\"https://blog.cloudflare.com/handshake-encryption-endgame-an-ech-update/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[3]</a>), 终于在近日以ECH(Encrypted Client Hello)的形式落地(<a href=\"https://blog.cloudflare.com/announcing-encrypted-client-hello/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[4]</a>)。至此, 经TLS加密的流量, 信道中间人的嗅探再也难以直接提取到除IP和端口号之外的信息 (但仍无法避免模式识别等间接手段的检测)。<br><br>鉴于巨大存量的非加密/明文的互联网基础设施和相关协议实现的复杂性, 想在早期体验到上述全程加密的好处, 仍需要服务端、客户端做相应设置。<br><br>对于使用Cloudflare作为CDN的免费用户, CF已经默认开启ECH支持。对于像bgm这样的付费用户, 需要手动到<a href=\"https://dash.cloudflare.com/?to=/:account/:zone/ssl-tls/edge-certificates\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">CF面板</a>开启ECH支持。由于ECH在TLSv1.2及以下不生效, 建议将最低TLS版本提升至TLSv1.3。<br><br><img src=\"https://p.sda1.dev/13/4b13e29139b2a01e468acf1c33a6086e/cf_tls_ech_setting.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br><br>在客户端, 如果你使用基于Chromium开发的浏览器(Chrome, Edge或其他变体), 在108版本之后乃至最新的117版, 仍需要手动启动ECH支持(不排除以后默认支持)。此外, 为了避免在通过DNS查询ECH所使用的公钥的过程中泄露所访问的域名, 强烈建议启用浏览器的DNS over HTTPS支持。对于Firefox浏览器, 请参考 <a href=\"https://blog.mozilla.org/security/2021/01/07/encrypted-client-hello-the-future-of-esni-in-firefox/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[10]</a> 。<br><br>▽Chrome 通过chrome://flags 开启ECH支持<br><img src=\"https://p.sda1.dev/13/e03cc346af5cfedd18c4ac46b9342b89/chrome_ech_enable.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>▽Chrome 开启DNS over HTTPS<br><img src=\"https://p.sda1.dev/13/d67c8e91abc9d9f443e59bb1029cdaf9/chrome_doh.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>▽Edge 通过启动参数 --enable-features=\"EncryptedClientHello\" 开启ECH支持 <br><img src=\"https://p.sda1.dev/13/aca357c917b2b5402b68e9eee4253d7c/edge_ech_enable.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br>▽Edge 开启DNS over HTTPS<br><img src=\"https://p.sda1.dev/13/6ec03a78b6016b23ac6da8267c6c738b/edge_doh.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br><br>想要校验是否已经成功开启ECH, 可通过检测站点(<a href=\"https://defo.ie/ech-check.php\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[5]</a>,<a href=\"https://tls-ech.dev/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[6]</a>), 也可自行抓包分析。对于早期的ESNI标准(现已弃用), 可通过CF提供的页面进行检测(<a href=\"https://crypto.cloudflare.com/cdn-cgi/trace\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[7]</a>,<a href=\"https://www.cloudflare.com/ssl/encrypted-sni\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">[8]</a>)。<br><br><img src=\"https://p.sda1.dev/13/6fa132ba8f35001745861595d0602170/ws_ech_sample_blur.png\" class=\"code\" rel=\"noreferrer\" referrerpolicy=\"no-referrer\" alt><br><br>最后强烈建议站长为本站开启ECH支持 <a href=\"/user/sai\" class=\"l\">@Sai&#x1F596;</a> 。<br><br>参考链接:<br>[1]: <a href=\"https://blog.cloudflare.com/encrypted-sni/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">Encrypt it or lose it: how encrypted SNI works</a><br>[2]: <a href=\"https://blog.cloudflare.com/encrypted-client-hello/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">Good-bye ESNI, hello ECH!</a><br>[3]: <a href=\"https://blog.cloudflare.com/handshake-encryption-endgame-an-ech-update/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">Handshake Encryption: Endgame (an ECH update) </a><br>[4]: <a href=\"https://blog.cloudflare.com/announcing-encrypted-client-hello/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">Encrypted Client Hello - the last puzzle piece to privacy</a><br>[5]: <a href=\"https://defo.ie/ech-check.php\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">defo.ie ECH check page</a><br>[6]: <a href=\"https://tls-ech.dev/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">tls-ech.dev</a><br>[7]: <a href=\"https://crypto.cloudflare.com/cdn-cgi/trace\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://crypto.cloudflare.com/cdn-cgi/trace</a><br>[8]: <a href=\"https://www.cloudflare.com/ssl/encrypted-sni\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">https://www.cloudflare.com/ssl/encrypted-sni</a><br>[9]: <a href=\"https://zhuanlan.zhihu.com/p/572101957\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">知乎专栏: TLS/ESNI/ECH/DoT/DoH/JA3 - 谈谈 HTTPS 网络下浏览体验安全性的最后缝隙</a><br>[10]: <a href=\"https://blog.mozilla.org/security/2021/01/07/encrypted-client-hello-the-future-of-esni-in-firefox/\" target=\"_blank\" rel=\"nofollow external noopener noreferrer\" class=\"l\">Encrypted Client Hello: the future of ESNI in Firefox</a>","time":"2023-9-30 16:13","title":"Cloudflare正式支持ECH (Encrypted Client Hello)","userId":"348269","userName":"SecureSocketLayer","userSign":""}