{"id":361172,"avatar":"//lain.bgm.tv/pic/user/m/000/37/43/374318.jpg","floor":"#1","group":"～技术宅真可怕～","groupHref":"/group/a","groupThumb":"//lain.bgm.tv/pic/icon/m/000/00/00/11.jpg","message":"不知道有没有班友在用 eagle 收集色图<img src=\"/img/smiles/tv/36.gif\" smileid=\"75\" alt=\"(bgm59)\">，然后遇到了和我一样的问题<br>这个问题（讨论？）可能有点冷门刁钻…<br>不过这真的不是广告<img src=\"/img/smiles/tv/35.gif\" smileid=\"74\" alt=\"(bgm58)\"><br><span style=\"font-weight:bold;\">TL; DR</span>: 可能因为 edge88 更新缓存访问机制与 CORS 的限制，浏览器插件无法访问 i.pximg.net 里的文件（色图）<br><br>事情是这样的，大概从 1/22 起，eagle 的 edge extension 就无法通过右键下载或者拖拽的方式获取 pixiv 上的色图了。<br><br>eagle 的 extension 获取色图的方法是，在图片上拖拽/通过右键菜单即可收藏。而实现逻辑是<br>1. 如果能在前端发起请求获取该图片的 base64 则发起，如果出错则转交给后端<br>2. 后端，即 eagle 的主程序有两个接口，一套 <a href=\"https://www.yuque.com/augus-gsjgn/eagle-api/yt2q0s\" target=\"_blank\" rel=\"nofollow external noopener\" class=\"l\">Open API</a> 和一套原本插件使用的 api，只有原生的 API 能够处理前端获取的 base64 以及 url 形式，只有 Open API 能够自定义请求的 header。<br><br>就在这段时间，发生了 edge88 更新、eagle 在 edge 的 extension 更新和 eagle 2.0.0 的更新。我简单通过时间顺序排查了一下，如果影响因素单一，edge88 的更新导致色图无法获取的可能性最高，以前可能是因为缓存的问题，以前在获取 base64 的时候直接访问缓存，正好绕过了 pixiv 的防盗链，但是现在不行了（存疑）。<br><br>我尝试从修改 eagle extension 入手，但是发现不太可能。因为<br>1. 从前端硬修改 referer 基本不可能，所以只能从浏览器插件向 pixiv.net 注入代码入手，i.pximg.net 访问的前提是 referer: <a href=\"https://www.pixiv.net\" target=\"_blank\" rel=\"nofollow external noopener\" class=\"l\">https://www.pixiv.net</a><br>2. 如果要通过 inject，必然是向主站进行前端注入，而若在此时访问 i.pximg.net 会导致跨域安全问题<br>3. 对于上面的问题，油猴脚本的 GM_xmlhttpRequest 可以解决问题，但是为了解决这个问题引入油猴有点太过复杂了点QAQ<br><br><span style=\"text-decoration: line-through;\">说实话我对油猴脚本为什么能进行跨域访问挺好奇的，这个有没有可能解决部分问题</span><br><br>但是，不知道是因为 bug 还是什么原因，通过 Open API 添加 header 来绕过盗链的办法行不通，eagle 就是无法下载图片（应该不是代理的问题，说巧不巧，eagle 2.0.0 取消了自定义代理，因此连抓包都变得复杂…）。<br><br>目前有几个解决方案，可以在 VPS 上自搭一个获取图片 b64 的脚本，然后通过 CORS 简单请求来访问那个脚本以获取 b64。还有一个解决方案是通过油猴脚本来进行跨域请求，然后通过这个骚操作（通过注入脚本以与油猴脚本建立联系）（类似）<br><div class=\"codeHighlight\"><pre><br>console.log(msg.src);<br>chrome.tabs.executeScript(<br>  tab.id,<br>  { code: `window.inject_url = \"${msg.src}\";` },<br>  () => {<br>    chrome.tabs.executeScript(<br>      tab.id, <br>      { file: \"pixiv.js\" }, <br>      (res) => {<br>        console.log(\"Exec: \" + res);<br>      });<br>  }<br>);<br></pre></div><br>将该脚本放到拓展的源文件中，再添加 pixiv.js 用于注入，来进行信息的共享，不知道可不可行<img src=\"/img/smiles/tv/78.gif\" smileid=\"117\" alt=\"(bgm101)\">。<br><br>但是这两个方案都一个比一个扯，不想折腾（小声），我也暂时想不到更好的方案<br>。放开 CORS 也不太好。<br><br>我本身并不会前端，因为昨天下午忽然发现下不了色图了气得我血脉喷张，于是花了点时间尝试解决这个问题<img src=\"/img/smiles/tv/60.gif\" smileid=\"99\" alt=\"(bgm83)\"> 但是好像依然没有完美的解决办法，我已经快累得放弃了qaq<br><br>各位有什么比较好的解决方案吗<img src=\"/img/smiles/tv/84.gif\" smileid=\"123\" alt=\"(bgm107)\"><br><br>---<br><br>Update: 2021/02/04<br><br>在 background.js 中 toDataURL() 函数里添加<br><div class=\"codeHighlight\"><pre><br>if (url.toLowerCase().indexOf('pximg.net') > -1) {<br>    // Using https://pixiv.cat/reverseproxy.html<br>    url = url.replace('pximg.net', 'pixiv.cat');<br>}<br></pre></div><br><br>可以使用现成的反代或者 Cloudflare Worker<br>我是真的没想到还有现成的反代这招啊啊啊啊<img src=\"/img/smiles/tv/57.gif\" smileid=\"96\" alt=\"(bgm80)\"><br>不过也算没白研究吧，感谢各位的支持<br>真的感谢各位<img src=\"/img/smiles/tv/03.gif\" smileid=\"42\" alt=\"(bgm26)\"><br><br>更没想到的是 eagle 的beta版修复了这个功能...（捂脸 ","time":"2021-2-4 15:31","title":"夺回通过 eagle 获取 pixiv 上色图的权力","userId":"kriaeth","userName":"⏳TraceBack⏳","userSign":"(大胆想象，谨慎思考)"}