[{"avatar":"//lain.bgm.tv/pic/user/m/000/20/56/205602.jpg","floor":"#2","id":"1351326","time":"2018-6-2 20:44","userId":"xiaowufeixia","userName":"逆淚","userSign":"(Rebuild!)","message":"+10086 急需 <img src=\"/img/smiles/tv/15.gif\" smileid=\"54\" alt=\"(bgm38)\">","sub":[]},{"avatar":"//lain.bgm.tv/pic/user/m/000/00/00/1.jpg","floor":"#3","id":"1352018","time":"2018-6-5 14:40","userId":"sai","userName":"Sai🖖","userSign":"(Awesome!)","message":"好了，试试看","sub":[{"avatar":"//lain.bgm.tv/pic/user/m/000/08/95/89561.jpg","floor":"#3-1","id":"1352019","time":"2018-6-5 14:53","userId":"upsuper","userName":"upsuper","userSign":"","message":"看起来可以了，非常感谢！<br>不过有一个小问题，似乎Access-Control-Allow-Origin的值是根据请求的referrer或者origin来决定的？如果这样的话，可能需要将相应的头加入vary头，不然的话在一个域名下请求后到另一个域名下再请求同样的内容会被拒绝。<br>因为API在HTTPS上，所以唯一可能影响的情况应该也就是一个人通过多个不同域名登入然后请求同一个网址了。大概大多数时候不会成为一个问题。"},{"avatar":"//lain.bgm.tv/pic/user/m/000/00/00/1.jpg","floor":"#3-2","id":"1352026","time":"2018-6-5 15:53","userId":"sai","userName":"Sai🖖","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">upsuper</span> 说: 看起来可以了，非常感谢！<br>不过有一个小问题，似乎Access-Control-Allow-Origin的值是根据请求的referrer或者origin来决定的？如果这样的话，可能需要将相应的头加入va...</q></div>加上了"},{"avatar":"//lain.bgm.tv/pic/user/m/000/08/95/89561.jpg","floor":"#3-3","id":"1352061","time":"2018-6-5 18:14","userId":"upsuper","userName":"upsuper","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">Sai</span> 说: 加上了</q></div>不对啊……vary没加上，Access-Control-Allow-Origin也没了啊（"},{"avatar":"//lain.bgm.tv/pic/user/m/000/00/00/1.jpg","floor":"#3-4","id":"1352064","time":"2018-6-5 18:31","userId":"sai","userName":"Sai🖖","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">upsuper</span> 说: 不对啊……vary没加上，Access-Control-Allow-Origin也没了啊（</q></div>我这有哇<br><div class=\"codeHighlight\"><pre>Response<br>:status: 200<br>Content-Type: application/json; charset=utf-8<br>Pragma: no-cache<br>Date: Tue, 05 Jun 2018 10:30:11 GMT<br>Cache-Control: no-cache, must-revalidate<br>Server: cloudflare<br>Access-Control-Allow-Origin: https://bgm.tv<br>Content-Encoding: gzip<br>Vary: Accept-Encoding<br>cf-ray: 4261f65fbb2ba960-SIN</pre></div>"},{"avatar":"//lain.bgm.tv/pic/user/m/000/08/95/89561.jpg","floor":"#3-5","id":"1352086","time":"2018-6-5 19:21","userId":"upsuper","userName":"upsuper","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">Sai</span> 说: 我这有哇<br>Response<br>:status: 200<br>Content-Type: application/json; charset=utf-8<br>Pragma: no-cache<br>Date: Tue,...</q></div>现在又有了……可能跟我之前用GM来调试有关系，缓存了一些没有orign的请求……<br>所以Vary还是没有加上的样子？"},{"avatar":"//lain.bgm.tv/pic/user/m/000/00/00/1.jpg","floor":"#3-6","id":"1352106","time":"2018-6-5 19:29","userId":"sai","userName":"Sai🖖","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">upsuper</span> 说: 现在又有了……可能跟我之前用GM来调试有关系，缓存了一些没有orign的请求……<br>所以Vary还是没有加上的样子？</q></div>有文档么？不就是 Vary: Accept-Encoding 这个？"},{"avatar":"//lain.bgm.tv/pic/user/m/000/08/95/89561.jpg","floor":"#3-7","id":"1352118","time":"2018-6-5 19:59","userId":"upsuper","userName":"upsuper","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">Sai</span> 说: 有文档么？不就是 Vary: Accept-Encoding 这个？</q></div>不不不，我的意思是说，浏览器或者中间代理节点可能对请求返回服务器之前的回复。像这里这样根据请求头里的Origin或者Referer来决定Access-Control-Allow-Origin的值的情况，如果通过一个域名请求过，在通过另一个域名请求的时候就可能因为使用缓存数据的关系，出现Access-Control-Allow-Origin与所在域名不匹配的情况导致CORS失败。<br><br>为了避免这种情况发生，服务器返回的时候应该说明，返回的结果会根据Origin/Referer发生变化，如果请求头中相应字段的值不同，需要重新向服务器发送请求，而不能使用缓存的结果。也就是说，Vary应该加上Origin或者Referer（取决于具体你使用的方式），比如说变成<div class=\"codeHighlight\"><pre>Vary: Accept-Encoding, Origin</pre></div>。<br><br>文档可以参考 <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Vary\" target=\"_blank\" rel=\"nofollow external noopener\" class=\"l\">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Vary</a>"},{"avatar":"//lain.bgm.tv/pic/user/m/000/00/00/1.jpg","floor":"#3-8","id":"1352219","time":"2018-6-6 11:46","userId":"sai","userName":"Sai🖖","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">upsuper</span> 说: 不不不，我的意思是说，浏览器或者中间代理节点可能对请求返回服务器之前的回复。像这里这样根据请求头里的Origin或者Referer来决定Access-Control-Allow-Origin的值的情况...</q></div>Response 里面 no-cache 也会被缓存么？"},{"avatar":"//lain.bgm.tv/pic/user/m/000/08/95/89561.jpg","floor":"#3-9","id":"1352231","time":"2018-6-6 13:29","userId":"upsuper","userName":"upsuper","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">Sai</span> 说: Response 里面 no-cache 也会被缓存么？</q></div>那应该就不会了，但你现在的response里面是 cache-control: max-age=3600 允许缓存一个小时呢"},{"avatar":"//lain.bgm.tv/pic/user/m/000/13/84/138463.jpg","floor":"#3-10","id":"1352826","time":"2018-6-8 04:39","userId":"tabemono","userName":"本集美食","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">upsuper</span> 说: 那应该就不会了，但你现在的response里面是 cache-control: max-age=3600 允许缓存一个小时呢</q></div>最后老板只允许了一个域名吗？<div class=\"codeHighlight\"><pre>https://bgm.tv/*</pre></div><img src=\"/img/smiles/tv/15.gif\" smileid=\"54\" alt=\"(bgm38)\"> 中文化脚本在其他域名不管用"},{"avatar":"//lain.bgm.tv/pic/user/m/000/08/95/89561.jpg","floor":"#3-11","id":"1352832","time":"2018-6-8 06:16","userId":"upsuper","userName":"upsuper","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">本集美食</span> 说: 最后老板只允许了一个域名吗？https://bgm.tv/* 中文化脚本在其他域名不管用</q></div>如果你在多个域名用的话会因为上面说的原因导致问题……不过我刚刚想到或许我可以在脚本里给请求加上后缀来绕过这个问题"},{"avatar":"//lain.bgm.tv/pic/user/m/000/00/64/6497.jpg","floor":"#3-12","id":"1352833","time":"2018-6-8 06:36","userId":"magicfish1990","userName":"铃猫 一边吃🥗一边","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">upsuper</span> 说: 如果你在多个域名用的话会因为上面说的原因导致问题……不过我刚刚想到或许我可以在脚本里给请求加上后缀来绕过这个问题</q></div>或者你也可以使用我的反代 <a href=\"https://mirror.bgm.rin.cat/api/\" target=\"_blank\" rel=\"nofollow external noopener\" class=\"l\">https://mirror.bgm.rin.cat/api/</a><img src=\"/img/smiles/tv/15.gif\" smileid=\"54\" alt=\"(bgm38)\">"},{"avatar":"//lain.bgm.tv/pic/user/m/000/08/95/89561.jpg","floor":"#3-13","id":"1352835","time":"2018-6-8 06:52","userId":"upsuper","userName":"upsuper","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">本集美食</span> 说: 最后老板只允许了一个域名吗？https://bgm.tv/* 中文化脚本在其他域名不管用</q></div>啊等等，这是我的错……忘记把其他域名加进去了（"},{"avatar":"//lain.bgm.tv/pic/user/m/000/09/06/90690.jpg","floor":"#3-14","id":"1357726","time":"2018-6-23 09:05","userId":"wattlebird","userName":"Genius、小乖🌟💯","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">MagicFish1990一边吃草一边</span> 说: 或者你也可以使用我的反代 https://mirror.bgm.rin.cat/api/ </q></div>How to use your RPed API? <a href=\"https://mirror.bgm.rin.cat/api/user/sai/\" target=\"_blank\" rel=\"nofollow external noopener\" class=\"l\">https://mirror.bgm.rin.cat/api/user/sai/</a> returns nothing."},{"avatar":"//lain.bgm.tv/pic/user/m/000/00/64/6497.jpg","floor":"#3-15","id":"1357737","time":"2018-6-23 11:19","userId":"magicfish1990","userName":"铃猫 一边吃🥗一边","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">Genius、小乖</span> 说: How to use your RPed API? https://mirror.bgm.rin.cat/api/user/sai/ returns nothing.</q></div>修好了<img src=\"/img/smiles/tv/15.gif\" smileid=\"54\" alt=\"(bgm38)\">"},{"avatar":"//lain.bgm.tv/pic/user/m/000/09/06/90690.jpg","floor":"#3-16","id":"1357743","time":"2018-6-23 12:49","userId":"wattlebird","userName":"Genius、小乖🌟💯","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">MagicFish1990一边吃草一边</span> 说: 修好了</q></div>Thank you for your quick fix. BTW, how long do you cache an API request?"},{"avatar":"//lain.bgm.tv/pic/user/m/000/00/64/6497.jpg","floor":"#3-17","id":"1357749","time":"2018-6-23 13:18","userId":"magicfish1990","userName":"铃猫 一边吃🥗一边","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">Genius、小乖</span> 说: Thank you for your quick fix. BTW, how long do you cache an API request?</q></div>30min"},{"avatar":"//lain.bgm.tv/pic/user/m/000/43/98/439898.jpg","floor":"#3-18","id":"1399047","time":"2018-11-22 10:30","userId":"439898","userName":"Kei","userSign":"","message":"<div class=\"quote\"><q><span style=\"font-weight:bold;\">upsuper</span> 说: 看起来可以了，非常感谢！<br>不过有一个小问题，似乎Access-Control-Allow-Origin的值是根据请求的referrer或者origin来决定的？如果这样的话，可能需要将相应的头加入va...</q></div>今天测试似乎没有看到Access-Control-Allow-Origin头 大佬能帮忙再看一下吗？<br><img src=\"https://ws1.sinaimg.cn/large/006RKGBply1fxgmrjounuj30e00ckdgk.jpg\" class=\"code\" alt>"}]},{"avatar":"//lain.bgm.tv/pic/user/m/000/28/76/287622.jpg","floor":"#4","id":"1357308","time":"2018-6-21 12:57","userId":"trim21","userName":"Trim21","userSign":"(异端比异教徒更可恨)","message":"想问一下 最后api允许的域名只有一楼提到的4个bgm自身的域名吗…","sub":[]},{"avatar":"//lain.bgm.tv/pic/user/m/000/28/76/287622.jpg","floor":"#5","id":"1362205","time":"2018-7-3 16:39","userId":"trim21","userName":"Trim21","userSign":"(异端比异教徒更可恨)","message":"嘛- -<br>建议也允许一下文档页面`<a href=\"https://bangumi.github.io/api/\" target=\"_blank\" rel=\"nofollow external noopener\" class=\"l\">https://bangumi.github.io/api/</a>`的跨域请求<br>这个文档本身是可以直接尝试调用api的,但是被跨域挡住了..","sub":[]}]